<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Creashift Corporate</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="index.css">
    <style>
        .admin-login-wrapper {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        .login-card {
            width: 100%;
            max-width: 450px;
            padding: var(--spacing-3xl);
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            text-align: center;
            z-index: 10;
        }

        .admin-dashboard {
            padding: var(--spacing-3xl);
            max-width: 1200px;
            margin: 0 auto;
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-3xl);
        }

        .post-form-card {
            background: var(--card-bg);
            padding: var(--spacing-2xl);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-3xl);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .full-width {
            grid-column: span 2;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: var(--font-body);
            margin-bottom: var(--spacing-md);
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .post-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        .admin-post-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: var(--spacing-lg);
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn {
            background: var(--accent-primary);
            color: white;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .tab-btn.active {
            background: var(--accent-primary) !important;
            color: white !important;
            box-shadow: 0 4px 15px var(--accent-glow);
        }
    </style>
</head>

<body data-theme="dark">
    <!-- Login Page -->
    <div class="admin-login-wrapper" id="login-section">
        <div class="section-video-bg">
            <video autoplay muted loop playsinline class="video-bg-element">
                <source
                    src="https://assets.mixkit.co/videos/preview/mixkit-digital-circuit-board-background-34509-large.mp4"
                    type="video/mp4">
            </video>
            <div class="video-overlay"></div>
        </div>

        <div class="login-card">
            <img src="assets/logo.png" alt="Creashift" style="width: 150px; margin-bottom: 2rem;">
            <h2 class="gradient-text">Command Center</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Authorized Personnel Only</p>
            <form id="login-form">
                <input type="text" id="email" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" class="btn-corporate btn-primary" style="width: 100%;">Initiate Session</button>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="admin-dashboard" id="dashboard-section">
        <header class="dashboard-header">
            <div>
                <h1 class="hero-title-corporate" style="font-size: 2rem;"><span class="gradient-text">Digital</span>
                    Asset Management</h1>
                <p style="color: var(--text-secondary);">Command your digital presence from one central hub.</p>
            </div>
            <button id="logout-btn" class="btn-corporate btn-secondary">Terminate Session</button>
        </header>

        <!-- Tab Navigation -->
        <div class="admin-tabs"
            style="display: flex; gap: 15px; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
            <button class="tab-btn active" onclick="switchTab('blogs')"
                style="background: transparent; border: none; color: var(--text-primary); cursor: pointer; font-weight: 600; padding: 10px 20px; border-radius: 8px;">Blogs</button>
            <button class="tab-btn" onclick="switchTab('hero')"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; padding: 10px 20px; border-radius: 8px;">Hero</button>
            <button class="tab-btn" onclick="switchTab('services')"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; padding: 10px 20px; border-radius: 8px;">Services</button>
            <button class="tab-btn" onclick="switchTab('metrics')"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; padding: 10px 20px; border-radius: 8px;">Metrics</button>
            <button class="tab-btn" onclick="switchTab('process')"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; padding: 10px 20px; border-radius: 8px;">Process</button>
        </div>

        <!-- HERO SECTION -->
        <div id="tab-hero" class="tab-content" style="display: none;">
            <section class="post-form-card">
                <h3>Global Identity (Hero)</h3>
                <form id="hero-form" style="margin-top: 1.5rem;">
                    <div class="form-grid">
                        <input type="text" id="hero-title1" placeholder="Title Line 1" required>
                        <input type="text" id="hero-title2" placeholder="Title Line 2 (Gradient)" required>
                        <textarea id="hero-subtitle" class="full-width" placeholder="Hero Subtitle" rows="2"
                            required></textarea>

                        <h4 class="full-width" style="margin: 1rem 0;">Highlight 1</h4>
                        <input type="text" id="h1-title" placeholder="Highlight 1 Title" required>
                        <input type="text" id="h1-desc" placeholder="Highlight 1 Description" required>

                        <h4 class="full-width" style="margin: 1rem 0;">Highlight 2</h4>
                        <input type="text" id="h2-title" placeholder="Highlight 2 Title" required>
                        <input type="text" id="h2-desc" placeholder="Highlight 2 Description" required>

                        <h4 class="full-width" style="margin: 1rem 0;">Highlight 3</h4>
                        <input type="text" id="h3-title" placeholder="Highlight 3 Title" required>
                        <input type="text" id="h3-desc" placeholder="Highlight 3 Description" required>
                    </div>
                    <button type="submit" class="btn-corporate btn-primary">Sync Identity</button>
                </form>
            </section>
        </div>

        <!-- BLOGS SECTION -->
        <div id="tab-blogs" class="tab-content">
            <section class="post-form-card">
                <h3>Deploy New Insight</h3>
                <form id="post-form" style="margin-top: 1.5rem;">
                    <div class="form-grid">
                        <input type="text" id="post-title" placeholder="Article Title" required>
                        <input type="text" id="post-category" placeholder="Strategic Category (e.g. AI, Strategy)"
                            required>
                        <input type="text" id="post-image" class="full-width" placeholder="Thumbnail Image URL">
                        <textarea id="post-excerpt" class="full-width" placeholder="Brief Summary" rows="2"
                            required></textarea>
                        <textarea id="post-content" class="full-width"
                            placeholder="Full Strategic Content (HTML allowed)" rows="6" required></textarea>
                    </div>
                    <button type="submit" class="btn-corporate btn-primary">Deploy to Mainframe</button>
                </form>
            </section>
            <h3>Active Assets</h3>
            <div class="post-list-grid" id="admin-post-list" style="margin-top: 1.5rem;"></div>
        </div>

        <!-- SERVICES SECTION -->
        <div id="tab-services" class="tab-content" style="display: none;">
            <section class="post-form-card">
                <h3>Provision New Service</h3>
                <form id="service-form" style="margin-top: 1.5rem;">
                    <div class="form-grid">
                        <input type="text" id="service-icon" placeholder="Emoji Icon (e.g. ðŸš€)" required>
                        <input type="text" id="service-title" placeholder="Service Name" required>
                        <input type="text" id="service-image" class="full-width" placeholder="Detail Hero Image URL">
                        <textarea id="service-desc" class="full-width" placeholder="Short Project Overview" rows="2"
                            required></textarea>
                        <textarea id="service-detailed-desc" class="full-width"
                            placeholder="Full Detailed Description (HTML allowed)" rows="6"></textarea>
                        <textarea id="service-features" class="full-width" placeholder="Key Features (One per line)"
                            rows="4"></textarea>
                        <textarea id="service-benefits" class="full-width" placeholder="Key Benefits (One per line)"
                            rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn-corporate btn-primary">Provision Service</button>
                </form>
            </section>
            <h3>Active Services</h3>
            <div class="post-list-grid" id="admin-service-list" style="margin-top: 1.5rem;"></div>
        </div>

        <!-- METRICS SECTION -->
        <div id="tab-metrics" class="tab-content" style="display: none;">
            <section class="post-form-card">
                <h3>Update Strategic Metrics</h3>
                <form id="metric-form" style="margin-top: 1.5rem;">
                    <div class="form-grid">
                        <input type="text" id="metric-label" placeholder="Metric Label (e.g. Clients)" required>
                        <input type="number" id="metric-target" placeholder="Target Number" required>
                        <input type="text" id="metric-suffix" placeholder="Suffix (e.g. +, %)">
                    </div>
                    <button type="submit" class="btn-corporate btn-primary">Deploy Metric</button>
                </form>
            </section>
            <h3>Operational Metrics</h3>
            <div class="post-list-grid" id="admin-metric-list" style="margin-top: 1.5rem;"></div>
        </div>

        <!-- PROCESS SECTION -->
        <div id="tab-process" class="tab-content" style="display: none;">
            <section class="post-form-card">
                <h3>Refine Workflow Step</h3>
                <form id="process-form" style="margin-top: 1.5rem;">
                    <div class="form-grid">
                        <input type="number" id="process-step" placeholder="Step Number" required>
                        <input type="text" id="process-title" placeholder="Step Title" required>
                        <textarea id="process-desc" class="full-width" placeholder="Process Explanation" rows="3"
                            required></textarea>
                    </div>
                    <button type="submit" class="btn-corporate btn-primary">Finalize Step</button>
                </form>
            </section>
            <h3>Project Methodology</h3>
            <div class="post-list-grid" id="admin-process-list" style="margin-top: 1.5rem;"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // UI Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                b.style.color = 'var(--text-secondary)';
            });

            document.getElementById(`tab-${tabName}`).style.display = 'block';
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase() === tabName);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.color = 'white';
            }

            // Load data for the tab
            if (tabName === 'blogs') loadPosts();
            if (tabName === 'hero') loadHero();
            if (tabName === 'services') loadServices();
            if (tabName === 'metrics') loadMetrics();
            if (tabName === 'process') loadProcess();
        }

        // --- LOGIN ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await response.text();
                    console.error("Server returned non-JSON response:", text);
                    throw new Error("Server error (Non-JSON response)");
                }

                const result = await response.json();

                if (response.ok && result.success) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    loadPosts();
                } else {
                    alert('ðŸš« ' + (result.message || 'Access Denied'));
                }
            } catch (err) {
                alert('âš ï¸ Server Offline');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => location.reload());

        // --- GENERIC DATA HANDLER ---
        async function crudAction(resource, method, data = null, id = '') {
            const url = id ? `${API_URL}/${resource}/${id}` : `${API_URL}/${resource}`;
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(url, options);

                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                if (response.ok) {
                    if (contentType && contentType.includes("application/json")) {
                        return await response.json();
                    }
                    return { success: true }; // Fallback for empty ok responses
                }

                // Handle errors
                if (contentType && contentType.includes("application/json")) {
                    const err = await response.json();
                    throw new Error(err.error || 'Action failed');
                } else {
                    const text = await response.text();
                    console.error("Action failed with non-JSON response:", text);
                    throw new Error(`Server error (${response.status})`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
                return null;
            }
        }

        // --- DASHBOARD LOADER ---
        async function loadResource(resource, containerId, templateFn) {
            const container = document.getElementById(containerId);
            container.innerHTML = '<p>Loading assets...</p>';
            const data = await crudAction(resource, 'GET');
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No strategic assets found.</p>';
                return;
            }
            container.innerHTML = data.map(templateFn).join('');
        }

        // --- BLOGS ---
        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('post-title').value,
                category: document.getElementById('post-category').value,
                image_url: document.getElementById('post-image').value,
                excerpt: document.getElementById('post-excerpt').value,
                content: document.getElementById('post-content').value
            };

            let success = false;
            if (currentEditId) {
                // Update existing post
                success = await crudAction('posts', 'PUT', data, currentEditId);
                currentEditId = null;
            } else {
                // Create new post
                success = await crudAction('posts', 'POST', data);
            }

            if (success) {
                e.target.reset();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Deploy to Mainframe';
                submitBtn.style.background = '';
                loadPosts();
            }
        });

        const loadPosts = () => loadResource('posts', 'admin-post-list', p => `
            <div class="admin-post-card">
                <div><strong>${p.title}</strong><br><small>${p.category}</small></div>
                <div class="admin-controls">
                    <div class="control-btn edit-btn" onclick="editPost('${p.id}')"><i class="fas fa-edit"></i></div>
                    <div class="control-btn delete-btn" onclick="deleteItem('posts', '${p.id}', loadPosts)"><i class="fas fa-trash"></i></div>
                </div>
            </div>
        `);

        // --- SERVICES ---
        document.getElementById('service-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                icon: document.getElementById('service-icon').value,
                title: document.getElementById('service-title').value,
                desc: document.getElementById('service-desc').value,
                image_url: document.getElementById('service-image').value,
                detailed_desc: document.getElementById('service-detailed-desc').value,
                features: document.getElementById('service-features').value,
                benefits: document.getElementById('service-benefits').value
            };

            let success = false;
            if (currentEditId) {
                // Update existing service
                success = await crudAction('services', 'PUT', data, currentEditId);
                currentEditId = null;
            } else {
                // Create new service
                success = await crudAction('services', 'POST', data);
            }

            if (success) {
                e.target.reset();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Provision Service';
                submitBtn.style.background = '';
                loadServices();
            }
        });

        const loadServices = () => loadResource('services', 'admin-service-list', s => `
            <div class="admin-post-card">
                <div><span>${s.icon}</span> <strong>${s.title}</strong></div>
                <div class="admin-controls">
                    <div class="control-btn edit-btn" onclick="editService('${s.id}')"><i class="fas fa-edit"></i></div>
                    <div class="control-btn delete-btn" onclick="deleteItem('services', '${s.id}', loadServices)"><i class="fas fa-trash"></i></div>
                </div>
            </div>
        `);

        // --- METRICS ---
        document.getElementById('metric-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                label: document.getElementById('metric-label').value,
                target: document.getElementById('metric-target').value,
                suffix: document.getElementById('metric-suffix').value
            };

            let success = false;
            if (currentEditId) {
                // Update existing metric
                success = await crudAction('metrics', 'PUT', data, currentEditId);
                currentEditId = null;
            } else {
                // Create new metric
                success = await crudAction('metrics', 'POST', data);
            }

            if (success) {
                e.target.reset();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Deploy Metric';
                submitBtn.style.background = '';
                loadMetrics();
            }
        });

        const loadMetrics = () => loadResource('metrics', 'admin-metric-list', m => `
            <div class="admin-post-card">
                <div><strong>${m.label}</strong>: ${m.target}${m.suffix || ''}</div>
                <div class="admin-controls">
                    <div class="control-btn edit-btn" onclick="editMetric('${m.id}')"><i class="fas fa-edit"></i></div>
                    <div class="control-btn delete-btn" onclick="deleteItem('metrics', '${m.id}', loadMetrics)"><i class="fas fa-trash"></i></div>
                </div>
            </div>
        `);

        // --- PROCESS ---
        document.getElementById('process-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                step: document.getElementById('process-step').value,
                title: document.getElementById('process-title').value,
                desc: document.getElementById('process-desc').value
            };

            let success = false;
            if (currentEditId) {
                // Update existing process item
                success = await crudAction('process', 'PUT', data, currentEditId);
                currentEditId = null;
            } else {
                // Create new process item
                success = await crudAction('process', 'POST', data);
            }

            if (success) {
                e.target.reset();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Finalize Step';
                submitBtn.style.background = '';
                loadProcess();
            }
        });

        const loadProcess = () => loadResource('process', 'admin-process-list', p => `
            <div class="admin-post-card">
                <div><strong>Step ${p.step}</strong>: ${p.title}</div>
                <div class="admin-controls">
                    <div class="control-btn edit-btn" onclick="editProcessItem('${p.id}')"><i class="fas fa-edit"></i></div>
                    <div class="control-btn delete-btn" onclick="deleteItem('process', '${p.id}', loadProcess)"><i class="fas fa-trash"></i></div>
                </div>
            </div>
        `);

        async function deleteItem(resource, id, reloadFn) {
            if (confirm(`Decommission this ${resource} asset?`)) {
                if (await crudAction(resource, 'DELETE', null, id)) reloadFn();
            }
        }

        // --- EDIT FUNCTIONS ---
        let currentEditId = null;

        async function editPost(id) {
            const posts = await crudAction('posts', 'GET');
            const post = posts.find(p => p.id === id);
            if (!post) return;

            currentEditId = id;
            document.getElementById('post-title').value = post.title;
            document.getElementById('post-category').value = post.category;
            document.getElementById('post-image').value = post.image_url || '';
            document.getElementById('post-excerpt').value = post.excerpt;
            document.getElementById('post-content').value = post.content;

            const submitBtn = document.querySelector('#post-form button[type="submit"]');
            submitBtn.textContent = 'Update Post';
            submitBtn.style.background = 'var(--accent-secondary)';

            // Scroll to form
            document.querySelector('#post-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function editService(id) {
            const services = await crudAction('services', 'GET');
            const service = services.find(s => s.id === id);
            if (!service) return;

            currentEditId = id;
            document.getElementById('service-icon').value = service.icon;
            document.getElementById('service-title').value = service.title;
            document.getElementById('service-desc').value = service.desc;
            document.getElementById('service-image').value = service.image_url || '';
            document.getElementById('service-detailed-desc').value = service.detailed_desc || '';
            document.getElementById('service-features').value = service.features || '';
            document.getElementById('service-benefits').value = service.benefits || '';

            const submitBtn = document.querySelector('#service-form button[type="submit"]');
            submitBtn.textContent = 'Update Service';
            submitBtn.style.background = 'var(--accent-secondary)';

            switchTab('services');
            document.querySelector('#service-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function editMetric(id) {
            const metrics = await crudAction('metrics', 'GET');
            const metric = metrics.find(m => m.id === id);
            if (!metric) return;

            currentEditId = id;
            document.getElementById('metric-label').value = metric.label;
            document.getElementById('metric-target').value = metric.target;
            document.getElementById('metric-suffix').value = metric.suffix || '';

            const submitBtn = document.querySelector('#metric-form button[type="submit"]');
            submitBtn.textContent = 'Update Metric';
            submitBtn.style.background = 'var(--accent-secondary)';

            switchTab('metrics');
            document.querySelector('#metric-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function editProcessItem(id) {
            const processItems = await crudAction('process', 'GET');
            const item = processItems.find(p => p.id === id);
            if (!item) return;

            currentEditId = id;
            document.getElementById('process-step').value = item.step;
            document.getElementById('process-title').value = item.title;
            document.getElementById('process-desc').value = item.desc;

            const submitBtn = document.querySelector('#process-form button[type="submit"]');
            submitBtn.textContent = 'Update Step';
            submitBtn.style.background = 'var(--accent-secondary)';

            switchTab('process');
            document.querySelector('#process-form').scrollIntoView({ behavior: 'smooth' });
        }

        // --- HERO ---
        async function loadHero() {
            const data = await crudAction('hero', 'GET');
            if (!data) return;

            document.getElementById('hero-title1').value = data.title_line1 || '';
            document.getElementById('hero-title2').value = data.title_line2 || '';
            document.getElementById('hero-subtitle').value = data.subtitle || '';

            if (data.highlights && data.highlights.length >= 3) {
                document.getElementById('h1-title').value = data.highlights[0].title;
                document.getElementById('h1-desc').value = data.highlights[0].desc;
                document.getElementById('h2-title').value = data.highlights[1].title;
                document.getElementById('h2-desc').value = data.highlights[1].desc;
                document.getElementById('h3-title').value = data.highlights[2].title;
                document.getElementById('h3-desc').value = data.highlights[2].desc;
            }
        }

        document.getElementById('hero-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title_line1: document.getElementById('hero-title1').value,
                title_line2: document.getElementById('hero-title2').value,
                subtitle: document.getElementById('hero-subtitle').value,
                highlights: [
                    { title: document.getElementById('h1-title').value, desc: document.getElementById('h1-desc').value },
                    { title: document.getElementById('h2-title').value, desc: document.getElementById('h2-desc').value },
                    { title: document.getElementById('h3-title').value, desc: document.getElementById('h3-desc').value }
                ]
            };

            const success = await crudAction('hero', 'PUT', data);
            if (success) {
                alert('ðŸš€ Identity Synced to Mainframe');
            }
        });
    </script>
</body>

</html>